<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin â€“ Lyko Lake</title>
<style>
:root{
  --ceo:#ff3b30;
  --admin:#34c759;
  --bg:#0a4d4d;
  --accent:#22c5a4;
  --card-bg:rgba(255,255,255,0.05);
  --border:rgba(34,197,164,0.3);
}
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  background:linear-gradient(135deg,var(--bg) 0%,#1a6b6b 50%,#0f3d3d 100%);
  color:#fff;
  min-height:100vh;
  padding:20px;
}
nav{
  background:rgba(10,77,77,0.95);
  backdrop-filter:blur(10px);
  padding:20px 40px;
  border-radius:15px;
  margin-bottom:30px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border:2px solid var(--border);
}
.logo{
  font-size:1.8em;
  font-weight:bold;
  color:var(--accent);
  text-decoration:none;
  display:flex;
  align-items:center;
  gap:10px;
}
h1{
  font-size:2.5em;
  margin:20px 0;
  background:linear-gradient(135deg,var(--accent) 0%,#4dd4b8 100%);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
}
.tabs{
  display:flex;
  gap:10px;
  margin-bottom:30px;
}
.tab{
  background:var(--card-bg);
  border:2px solid var(--border);
  color:rgba(255,255,255,0.7);
  padding:12px 24px;
  border-radius:10px;
  cursor:pointer;
  transition:all 0.3s;
  font-weight:600;
}
.tab:hover{
  background:rgba(34,197,164,0.1);
}
.tab.active{
  background:rgba(34,197,164,0.2);
  border-color:var(--accent);
  color:var(--accent);
}
.tab-content{
  display:none;
}
.tab-content.active{
  display:block;
}
.stats-bar{
  display:flex;
  gap:20px;
  margin-bottom:30px;
  flex-wrap:wrap;
}
.stat-card{
  background:var(--card-bg);
  border:2px solid var(--border);
  border-radius:12px;
  padding:20px;
  flex:1;
  min-width:200px;
  backdrop-filter:blur(10px);
}
.stat-label{
  color:rgba(255,255,255,0.6);
  font-size:0.9em;
  margin-bottom:8px;
  text-transform:uppercase;
  letter-spacing:1px;
}
.stat-value{
  font-size:2em;
  font-weight:bold;
  color:var(--accent);
}
.loading{
  text-align:center;
  padding:60px 20px;
  font-size:1.2em;
  color:rgba(255,255,255,0.7);
}
.error-message{
  background:rgba(255,59,48,0.2);
  border:2px solid rgba(255,59,48,0.5);
  color:#ff3b30;
  padding:20px;
  border-radius:12px;
  margin-bottom:20px;
  text-align:center;
}
.users-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(300px,1fr));
  gap:20px;
}
.user-card{
  background:var(--card-bg);
  border:2px solid var(--border);
  border-radius:15px;
  padding:25px;
  backdrop-filter:blur(10px);
  transition:transform 0.3s,box-shadow 0.3s;
  display:flex;
  flex-direction:column;
  gap:12px;
}
.user-card:hover{
  transform:translateY(-5px);
  box-shadow:0 10px 30px rgba(0,0,0,0.4);
}
.report-card{
  background:var(--card-bg);
  border:2px solid var(--border);
  border-radius:15px;
  padding:25px;
  margin-bottom:20px;
}
.report-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:15px;
}
.report-status{
  padding:6px 12px;
  border-radius:20px;
  font-size:0.8em;
  font-weight:600;
}
.report-status.pending{
  background:rgba(255,204,0,0.2);
  color:#fc0;
}
.report-status.reviewed{
  background:rgba(52,199,89,0.2);
  color:#34c759;
}
.report-content{
  color:rgba(255,255,255,0.8);
  line-height:1.6;
  margin-bottom:15px;
}
.log-entry{
  background:var(--card-bg);
  border:2px solid var(--border);
  border-radius:10px;
  padding:15px;
  margin-bottom:10px;
  font-size:0.9em;
}
.log-time{
  color:rgba(255,255,255,0.5);
  font-size:0.85em;
}
.log-action{
  color:var(--accent);
  font-weight:600;
}
.btn{
  background:rgba(255,255,255,0.1);
  border:1px solid rgba(255,255,255,0.3);
  color:#fff;
  padding:8px 14px;
  border-radius:8px;
  cursor:pointer;
  font-size:0.85em;
  font-weight:500;
  transition:all 0.2s;
  white-space:nowrap;
}
.btn:hover:not(:disabled){
  background:rgba(255,255,255,0.2);
  transform:translateY(-2px);
}
.btn:disabled{
  opacity:0.4;
  cursor:not-allowed;
}
.btn.danger{
  border-color:rgba(255,59,48,0.5);
  background:rgba(255,59,48,0.2);
}
.btn.danger:hover:not(:disabled){
  background:rgba(255,59,48,0.3);
}
.btn.success{
  border-color:rgba(52,199,89,0.5);
  background:rgba(52,199,89,0.2);
}
.btn.success:hover:not(:disabled){
  background:rgba(52,199,89,0.3);
}
.hidden{display:none!important}
</style>
</head>
<body>

<nav>
  <a href="/" class="logo">ðŸŒŠ Lyko Lake</a>
</nav>

<h1>Admin Panel</h1>

<div class="tabs">
  <div class="tab active" data-tab="users">Users</div>
  <div class="tab" data-tab="reports">Reports</div>
  <div class="tab" data-tab="logs">Audit Log</div>
</div>

<div id="errorContainer"></div>
<div id="loadingContainer" class="loading">Loading...</div>

<!-- USERS TAB -->
<div class="tab-content active" id="users-tab">
  <div class="stats-bar">
    <div class="stat-card">
      <div class="stat-label">Total Users</div>
      <div class="stat-value" id="totalUsers">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Admins</div>
      <div class="stat-value" id="totalAdmins">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Banned</div>
      <div class="stat-value" id="totalBanned">0</div>
    </div>
  </div>
  <div id="usersGrid" class="users-grid"></div>
</div>

<!-- REPORTS TAB -->
<div class="tab-content" id="reports-tab">
  <div id="reportsContainer"></div>
</div>

<!-- LOGS TAB -->
<div class="tab-content" id="logs-tab">
  <div id="logsContainer"></div>
</div>

<script type="module">
import {initializeApp} from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import {getAuth,onAuthStateChanged} from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
import {getFirestore,collection,getDocs,doc,getDoc,updateDoc,setDoc,deleteDoc,serverTimestamp,Timestamp,query,orderBy,addDoc,where} from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyDUBeWvs6kOijqST6FVGirWs2EZ12aAAwU",
  authDomain: "lyko-lake.firebaseapp.com",
  projectId: "lyko-lake",
  storageBucket: "lyko-lake.firebasestorage.app",
  messagingSenderId: "685592614306",
  appId: "1:685592614306:web:b6a8f6f18407f9c0154efb"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentAdmin = null;
let allUsers = [];
let allReports = [];
let allLogs = [];

const errorContainer = document.getElementById('errorContainer');
const loadingContainer = document.getElementById('loadingContainer');

function showError(msg) {
  errorContainer.innerHTML = `<div class="error-message">${msg}</div>`;
}

function hideError() {
  errorContainer.innerHTML = '';
}

// Tab switching
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
  });
});

// Check permissions
onAuthStateChanged(auth, async user => {
  if (!user) {
    window.location.href = '/auth.html';
    return;
  }
  
  try {
    const userDoc = await getDoc(doc(db, 'users', user.uid));
    if (!userDoc.exists()) {
      showError('User profile not found.');
      loadingContainer.classList.add('hidden');
      return;
    }
    
    const userData = userDoc.data();
    if (!(userData.rank === 'CEO' || userData.rank === 'Admin')) {
      showError('Access denied. Admin or CEO rank required.');
      loadingContainer.classList.add('hidden');
      return;
    }
    
    currentAdmin = { ...userData, userId: user.uid };
    await loadData();
  } catch (e) {
    console.error('Permission check error:', e);
    showError(`Permission check failed: ${e.message}`);
    loadingContainer.classList.add('hidden');
  }
});

async function loadData() {
  hideError();
  loadingContainer.classList.remove('hidden');
  
  try {
    await Promise.all([
      loadUsers(),
      loadReports(),
      loadLogs()
    ]);
    loadingContainer.classList.add('hidden');
  } catch (e) {
    console.error('Error loading data:', e);
    showError(`Failed to load data: ${e.message}`);
    loadingContainer.classList.add('hidden');
  }
}

async function loadUsers() {
  try {
    const usersQuery = query(collection(db, 'users'), orderBy('uid', 'asc'));
    const usersSnap = await getDocs(usersQuery);
    
    let bansSnap;
    try {
      bansSnap = await getDocs(collection(db, 'bans'));
    } catch (e) {
      console.warn('Could not load bans:', e.message);
      bansSnap = { forEach: () => {} };
    }
    
    const banMap = {};
    bansSnap.forEach(d => {
      const data = d.data();
      const isBanned = !data.until || Date.now() < data.until.toMillis();
      if (isBanned) banMap[d.id] = data;
    });
    
    allUsers = [];
    usersSnap.forEach(d => {
      const userData = {...d.data(), userId: d.id};
      userData.banned = !!banMap[d.id];
      userData.banData = banMap[d.id] || null;
      allUsers.push(userData);
    });
    
    allUsers.sort((a, b) => {
      const rankOrder = {CEO: 0, Admin: 1};
      const aRank = rankOrder[a.rank] ?? 2;
      const bRank = rankOrder[b.rank] ?? 2;
      if (aRank !== bRank) return aRank - bRank;
      return (a.uid || 0) - (b.uid || 0);
    });
    
    document.getElementById('totalUsers').textContent = allUsers.length;
    document.getElementById('totalAdmins').textContent = allUsers.filter(u => u.rank === 'Admin' || u.rank === 'CEO').length;
    document.getElementById('totalBanned').textContent = allUsers.filter(u => u.banned).length;
    
    renderUsers();
  } catch (e) {
    console.error('Error loading users:', e);
    throw e;
  }
}

async function loadReports() {
  try {
    const reportsSnap = await getDocs(query(collection(db, 'reports'), orderBy('createdAt', 'desc')));
    allReports = [];
    reportsSnap.forEach(d => {
      allReports.push({ id: d.id, ...d.data() });
    });
    renderReports();
  } catch (e) {
    console.error('Error loading reports:', e);
  }
}

async function loadLogs() {
  try {
    const logsSnap = await getDocs(query(collection(db, 'adminLogs'), orderBy('timestamp', 'desc')));
    allLogs = [];
    logsSnap.forEach(d => {
      allLogs.push({ id: d.id, ...d.data() });
    });
    renderLogs();
  } catch (e) {
    console.error('Error loading logs:', e);
  }
}

function renderUsers() {
  const grid = document.getElementById('usersGrid');
  grid.innerHTML = '';
  
  allUsers.forEach(user => {
    const card = document.createElement('div');
    card.className = 'user-card';
    
    const isCEO = user.rank === 'CEO';
    const isAdmin = user.rank === 'Admin';
    const isBanned = user.banned;
    
    let badges = '';
    if (isBanned) badges += '<span style="background:#ff3b30;padding:3px 8px;border-radius:12px;font-size:0.7em;font-weight:700">BANNED</span> ';
    if (isCEO) badges += '<span style="background:#ff3b30;padding:3px 8px;border-radius:12px;font-size:0.7em;font-weight:700">CEO</span>';
    else if (isAdmin) badges += '<span style="background:#34c759;padding:3px 8px;border-radius:12px;font-size:0.7em;font-weight:700">ADMIN</span>';
    
    card.innerHTML = `
      <div style="display:flex;align-items:center;gap:15px">
        <img style="width:60px;height:60px;border-radius:50%;object-fit:cover" src="${user.avatar || 'https://via.placeholder.com/60'}" alt="${user.displayName}">
        <div style="flex:1">
          <div style="font-size:1.2em;font-weight:600;margin-bottom:4px">${user.displayName} ${badges}</div>
          <div style="color:rgba(255,255,255,0.6);font-size:0.9em">@${user.username}</div>
        </div>
      </div>
      <div style="display:flex;gap:15px;color:rgba(255,255,255,0.5);font-size:0.85em">
        <span>ðŸ‘¤ User #${user.uid || 'N/A'}</span>
      </div>
      <div id="actions-${user.userId}" style="display:flex;flex-wrap:wrap;gap:8px"></div>
    `;
    
    const actionsDiv = card.querySelector(`#actions-${user.userId}`);
    
    if (isCEO) {
      actionsDiv.innerHTML = '<span style="color:rgba(255,255,255,0.5);font-size:0.9em;font-style:italic">Protected account</span>';
    } else {
      if (isBanned) {
        const btn = document.createElement('button');
        btn.className = 'btn success';
        btn.textContent = 'Unban';
        btn.onclick = () => unbanUser(user);
        actionsDiv.appendChild(btn);
      } else {
        const banBtn = document.createElement('button');
        banBtn.className = 'btn danger';
        banBtn.textContent = 'Ban';
        banBtn.onclick = () => banUser(user);
        actionsDiv.appendChild(banBtn);
      }
      
      const muteBtn = document.createElement('button');
      muteBtn.className = 'btn';
      muteBtn.textContent = user.muted ? 'Unmute' : 'Mute';
      muteBtn.onclick = () => muteUser(user);
      actionsDiv.appendChild(muteBtn);
    }
    
    grid.appendChild(card);
  });
}

function renderReports() {
  const container = document.getElementById('reportsContainer');
  container.innerHTML = '';
  
  if (allReports.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:60px;color:rgba(255,255,255,0.6)">No reports</div>';
    return;
  }
  
  allReports.forEach(report => {
    const card = document.createElement('div');
    card.className = 'report-card';
    
    card.innerHTML = `
      <div class="report-header">
        <span class="report-status ${report.status || 'pending'}">${report.status || 'pending'}</span>
        <span style="color:rgba(255,255,255,0.5);font-size:0.9em">${report.createdAt ? new Date(report.createdAt.toMillis()).toLocaleString() : 'Unknown time'}</span>
      </div>
      <div class="report-content">
        <strong>Post ID:</strong> ${report.postId}<br>
        <strong>Reported by:</strong> ${report.reportedBy}<br>
        <strong>Reason:</strong> ${report.reason}
      </div>
      <div style="display:flex;gap:10px">
        <button class="btn" onclick="viewPost('${report.postId}')">View Post</button>
        <button class="btn danger" onclick="deletePost('${report.postId}', '${report.id}')">Delete Post</button>
        <button class="btn success" onclick="dismissReport('${report.id}')">Dismiss</button>
      </div>
    `;
    
    container.appendChild(card);
  });
}

function renderLogs() {
  const container = document.getElementById('logsContainer');
  container.innerHTML = '';
  
  if (allLogs.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:60px;color:rgba(255,255,255,0.6)">No audit logs</div>';
    return;
  }
  
  allLogs.forEach(log => {
    const entry = document.createElement('div');
    entry.className = 'log-entry';
    
    entry.innerHTML = `
      <div class="log-action">${log.action}</div>
      <div style="color:rgba(255,255,255,0.7);margin:5px 0">${log.details}</div>
      <div class="log-time">By ${log.adminName} â€¢ ${log.timestamp ? new Date(log.timestamp.toMillis()).toLocaleString() : 'Unknown time'}</div>
    `;
    
    container.appendChild(entry);
  });
}

async function logAction(action, details, targetUserId = null) {
  try {
    await addDoc(collection(db, 'adminLogs'), {
      action,
      details,
      adminId: currentAdmin.userId,
      adminName: currentAdmin.displayName,
      targetUserId,
      timestamp: serverTimestamp()
    });
  } catch (e) {
    console.error('Failed to log action:', e);
  }
}

async function banUser(user) {
  const reason = prompt('Ban reason:');
  if (!reason) return;
  
  try {
    await setDoc(doc(db, 'bans', user.userId), {
      until: null,
      reason,
      by: currentAdmin.userId,
      byName: currentAdmin.displayName,
      at: serverTimestamp()
    });
    
    await updateDoc(doc(db, 'users', user.userId), { muted: true });
    await logAction('User Banned', `Banned @${user.username} for: ${reason}`, user.userId);
    await loadData();
  } catch (e) {
    alert('Failed to ban user: ' + e.message);
  }
}

async function unbanUser(user) {
  if (!confirm(`Unban @${user.username}?`)) return;
  
  try {
    await deleteDoc(doc(db, 'bans', user.userId));
    await updateDoc(doc(db, 'users', user.userId), { muted: false });
    await logAction('User Unbanned', `Unbanned @${user.username}`, user.userId);
    await loadData();
  } catch (e) {
    alert('Failed to unban user: ' + e.message);
  }
}

async function muteUser(user) {
  const action = user.muted ? 'unmute' : 'mute';
  if (!confirm(`${action} @${user.username}?`)) return;
  
  try {
    await updateDoc(doc(db, 'users', user.userId), { muted: !user.muted });
    await logAction(`User ${action}d`, `${action}d @${user.username}`, user.userId);
    await loadData();
  } catch (e) {
    alert('Failed to ' + action + ' user: ' + e.message);
  }
}

window.viewPost = async function(postId) {
  try {
    const postSnap = await getDoc(doc(db, 'posts', postId));
    if (!postSnap.exists()) {
      alert('Post not found (may have been deleted)');
      return;
    }
    const post = postSnap.data();
    
    let mediaPreview = '';
    if (post.mediaUrl) {
      if (post.mediaType === 'video') {
        mediaPreview = `<video controls style="max-width:100%;max-height:400px;border-radius:10px" src="${post.mediaUrl}"></video>`;
      } else {
        mediaPreview = `<img style="max-width:100%;max-height:400px;border-radius:10px" src="${post.mediaUrl}">`;
      }
    }
    
    alert(`Post Content:\n\n${post.content || 'No text content'}\n\n${mediaPreview ? '(Media attached - see preview in console)' : 'No media'}\n\nLikes: ${post.likes || 0}\nViews: ${post.views || 0}`);
  } catch (e) {
    alert('Failed to load post: ' + e.message);
  }
};

window.deletePost = async function(postId, reportId) {
  if (!confirm('Delete this post? This action cannot be undone.')) return;
  
  try {
    await deleteDoc(doc(db, 'posts', postId));
    await deleteDoc(doc(db, 'reports', reportId));
    await logAction('Post Deleted', `Deleted post ${postId} from report`);
    await loadData();
  } catch (e) {
    alert('Failed to delete post: ' + e.message);
  }
};

window.dismissReport = async function(reportId) {
  try {
    await updateDoc(doc(db, 'reports', reportId), { status: 'reviewed' });
    await logAction('Report Dismissed', `Dismissed report ${reportId}`);
    await loadData();
  } catch (e) {
    alert('Failed to dismiss report: ' + e.message);
  }
};
</script>

</body>
</html>
