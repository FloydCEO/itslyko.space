<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin â€“ Lyko Lake</title>
<style>
:root{
  --ceo:#ff3b30;
  --admin:#34c759;
  --bg:#0a4d4d;
  --accent:#22c5a4;
  --card-bg:rgba(255,255,255,0.05);
  --border:rgba(34,197,164,0.3);
}
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  background:linear-gradient(135deg,var(--bg) 0%,#1a6b6b 50%,#0f3d3d 100%);
  color:#fff;
  min-height:100vh;
  padding:20px;
}
nav{
  background:rgba(10,77,77,0.95);
  backdrop-filter:blur(10px);
  padding:20px 40px;
  border-radius:15px;
  margin-bottom:30px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border:2px solid var(--border);
}
.logo{
  font-size:1.8em;
  font-weight:bold;
  color:var(--accent);
  text-decoration:none;
  display:flex;
  align-items:center;
  gap:10px;
}
h1{
  font-size:2.5em;
  margin:20px 0;
  background:linear-gradient(135deg,var(--accent) 0%,#4dd4b8 100%);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
}
.stats-bar{
  display:flex;
  gap:20px;
  margin-bottom:30px;
  flex-wrap:wrap;
}
.stat-card{
  background:var(--card-bg);
  border:2px solid var(--border);
  border-radius:12px;
  padding:20px;
  flex:1;
  min-width:200px;
  backdrop-filter:blur(10px);
}
.stat-label{
  color:rgba(255,255,255,0.6);
  font-size:0.9em;
  margin-bottom:8px;
  text-transform:uppercase;
  letter-spacing:1px;
}
.stat-value{
  font-size:2em;
  font-weight:bold;
  color:var(--accent);
}
.loading{
  text-align:center;
  padding:60px 20px;
  font-size:1.2em;
  color:rgba(255,255,255,0.7);
}
.error-message{
  background:rgba(255,59,48,0.2);
  border:2px solid rgba(255,59,48,0.5);
  color:#ff3b30;
  padding:20px;
  border-radius:12px;
  margin-bottom:20px;
  text-align:center;
}
.users-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(300px,1fr));
  gap:20px;
}
.user-card{
  background:var(--card-bg);
  border:2px solid var(--border);
  border-radius:15px;
  padding:25px;
  backdrop-filter:blur(10px);
  transition:transform 0.3s,box-shadow 0.3s;
  display:flex;
  flex-direction:column;
  gap:12px;
}
.user-card:hover{
  transform:translateY(-5px);
  box-shadow:0 10px 30px rgba(0,0,0,0.4);
}
.user-header{
  display:flex;
  align-items:center;
  gap:15px;
}
.user-avatar{
  width:60px;
  height:60px;
  border-radius:50%;
  background:var(--accent);
  object-fit:cover;
  flex-shrink:0;
}
.user-info{
  flex:1;
  min-width:0;
}
.user-display{
  font-size:1.2em;
  font-weight:600;
  word-break:break-word;
  margin-bottom:4px;
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
}
.user-username{
  color:rgba(255,255,255,0.6);
  font-size:0.9em;
  word-break:break-word;
}
.rank-badge{
  display:inline-block;
  padding:3px 8px;
  border-radius:12px;
  font-size:0.7em;
  font-weight:700;
  text-transform:uppercase;
  letter-spacing:0.5px;
}
.rank-badge.ceo{
  background:var(--ceo);
  box-shadow:0 0 10px var(--ceo);
  animation:pulse 2s infinite;
}
.rank-badge.admin{
  background:var(--admin);
}
.rank-badge.banned{
  background:#ff3b30;
  box-shadow:0 0 10px #ff3b30;
}
@keyframes pulse{
  0%,100%{opacity:1}
  50%{opacity:0.7}
}
.user-meta{
  display:flex;
  gap:15px;
  font-size:0.85em;
  color:rgba(255,255,255,0.5);
  flex-wrap:wrap;
}
.user-meta span{
  display:flex;
  align-items:center;
  gap:5px;
}
.actions{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:8px;
}
.btn{
  background:rgba(255,255,255,0.1);
  border:1px solid rgba(255,255,255,0.3);
  color:#fff;
  padding:8px 14px;
  border-radius:8px;
  cursor:pointer;
  font-size:0.85em;
  font-weight:500;
  transition:all 0.2s;
  white-space:nowrap;
}
.btn:hover:not(:disabled){
  background:rgba(255,255,255,0.2);
  transform:translateY(-2px);
}
.btn:disabled{
  opacity:0.4;
  cursor:not-allowed;
}
.btn.danger{
  border-color:rgba(255,59,48,0.5);
  background:rgba(255,59,48,0.2);
}
.btn.danger:hover:not(:disabled){
  background:rgba(255,59,48,0.3);
}
.btn.success{
  border-color:rgba(52,199,89,0.5);
  background:rgba(52,199,89,0.2);
}
.btn.success:hover:not(:disabled){
  background:rgba(52,199,89,0.3);
}
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.8);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
  padding:20px;
}
.modal.show{display:flex}
.modal-content{
  background:#0a4d4d;
  border:2px solid var(--accent);
  border-radius:15px;
  padding:30px;
  width:100%;
  max-width:500px;
  max-height:90vh;
  overflow-y:auto;
}
.modal-header{
  font-size:1.5em;
  color:var(--accent);
  margin-bottom:20px;
  font-weight:600;
}
.form-group{
  margin-bottom:20px;
}
.form-label{
  display:block;
  margin-bottom:8px;
  color:rgba(255,255,255,0.9);
  font-weight:500;
}
.form-input,
.form-select,
.form-textarea{
  width:100%;
  padding:12px;
  border-radius:8px;
  border:2px solid var(--border);
  background:rgba(255,255,255,0.05);
  color:#fff;
  font-family:inherit;
  font-size:1em;
  transition:border-color 0.3s;
}
.form-input:focus,
.form-select:focus,
.form-textarea:focus{
  outline:none;
  border-color:var(--accent);
  background:rgba(34,197,164,0.1);
}
.form-textarea{
  resize:vertical;
  min-height:80px;
}
.modal-actions{
  display:flex;
  gap:12px;
  justify-content:flex-end;
  margin-top:25px;
}
.modal-btn{
  background:rgba(34,197,164,0.2);
  border:2px solid var(--accent);
  color:#fff;
  padding:12px 24px;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
  transition:all 0.3s;
}
.modal-btn:hover{
  background:var(--accent);
  color:#0a4d4d;
}
.modal-btn.secondary{
  background:rgba(255,255,255,0.1);
  border-color:rgba(255,255,255,0.3);
}
.modal-btn.secondary:hover{
  background:rgba(255,255,255,0.2);
  color:#fff;
}
.hidden{display:none!important}
@media(max-width:768px){
  body{padding:10px}
  nav{padding:15px 20px}
  h1{font-size:2em}
  .users-grid{grid-template-columns:1fr}
  .stat-card{min-width:100%}
}
</style>
</head>
<body>

<nav>
  <a href="/" class="logo">ðŸŒŠ Lyko Lake</a>
</nav>

<h1>Admin Panel</h1>

<div class="stats-bar">
  <div class="stat-card">
    <div class="stat-label">Total Users</div>
    <div class="stat-value" id="totalUsers">0</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Admins</div>
    <div class="stat-value" id="totalAdmins">0</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Banned</div>
    <div class="stat-value" id="totalBanned">0</div>
  </div>
</div>

<div id="errorContainer"></div>
<div id="loadingContainer" class="loading">Loading users...</div>
<div id="usersGrid" class="users-grid"></div>

<!-- Modal -->
<div id="modal" class="modal">
  <div class="modal-content">
    <div class="modal-header" id="modalHeader">Action</div>
    <div id="modalBody"></div>
    <div class="modal-actions">
      <button class="modal-btn secondary" id="modalCancel">Cancel</button>
      <button class="modal-btn" id="modalConfirm">Confirm</button>
    </div>
  </div>
</div>

<script type="module">
import {initializeApp} from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import {getAuth,onAuthStateChanged} from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
import {getFirestore,collection,getDocs,doc,getDoc,updateDoc,setDoc,deleteDoc,serverTimestamp,Timestamp} from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

const firebaseConfig = {
  apiKey: "AIzaSyDUBeWvs6kOijqST6FVGirWs2EZ12aAAwU",
  authDomain: "lyko-lake.firebaseapp.com",
  projectId: "lyko-lake",
  storageBucket: "lyko-lake.firebasestorage.app",
  messagingSenderId: "685592614306",
  appId: "1:685592614306:web:b6a8f6f18407f9c0154efb"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const usersGrid = document.getElementById('usersGrid');
const loadingContainer = document.getElementById('loadingContainer');
const errorContainer = document.getElementById('errorContainer');
const modal = document.getElementById('modal');
const modalHeader = document.getElementById('modalHeader');
const modalBody = document.getElementById('modalBody');
const modalCancel = document.getElementById('modalCancel');
const modalConfirm = document.getElementById('modalConfirm');
const totalUsersEl = document.getElementById('totalUsers');
const totalAdminsEl = document.getElementById('totalAdmins');
const totalBannedEl = document.getElementById('totalBanned');

let currentAction = null;
let allUsers = [];

function showError(msg) {
  errorContainer.innerHTML = `<div class="error-message">${msg}</div>`;
}

function hideError() {
  errorContainer.innerHTML = '';
}

function showModal(title, body, onConfirm) {
  modalHeader.textContent = title;
  modalBody.innerHTML = body;
  currentAction = onConfirm;
  modal.classList.add('show');
}

function hideModal() {
  modal.classList.remove('show');
  currentAction = null;
}

modalCancel.onclick = hideModal;
modalConfirm.onclick = async () => {
  if (currentAction) {
    try {
      await currentAction();
      hideModal();
      await loadUsers();
    } catch (e) {
      showError(`Action failed: ${e.message}`);
    }
  }
};

// Check permissions
onAuthStateChanged(auth, async user => {
  if (!user) {
    window.location.href = '/auth.html';
    return;
  }
  
  try {
    const userDoc = await getDoc(doc(db, 'users', user.uid));
    if (!userDoc.exists() || userDoc.data().rank !== 'CEO') {
      showError('Access denied. CEO rank required.');
      loadingContainer.classList.add('hidden');
      return;
    }
    await loadUsers();
  } catch (e) {
    showError(`Permission check failed: ${e.message}`);
    loadingContainer.classList.add('hidden');
  }
});

async function loadUsers() {
  hideError();
  loadingContainer.classList.remove('hidden');
  usersGrid.innerHTML = '';
  
  try {
    const usersSnap = await getDocs(collection(db, 'users'));
    const bansSnap = await getDocs(collection(db, 'bans'));
    
    const banMap = {};
    bansSnap.forEach(d => {
      const data = d.data();
      const isBanned = !data.until || Date.now() < data.until.toMillis();
      if (isBanned) banMap[d.id] = data;
    });
    
    allUsers = [];
    usersSnap.forEach(d => {
      const userData = {...d.data(), userId: d.id};
      userData.banned = !!banMap[d.id];
      userData.banData = banMap[d.id] || null;
      allUsers.push(userData);
    });
    
    // Sort: CEOs first, then Admins, then others
    allUsers.sort((a, b) => {
      const rankOrder = {CEO: 0, Admin: 1};
      const aRank = rankOrder[a.rank] ?? 2;
      const bRank = rankOrder[b.rank] ?? 2;
      if (aRank !== bRank) return aRank - bRank;
      return (a.uid || 0) - (b.uid || 0);
    });
    
    // Update stats
    totalUsersEl.textContent = allUsers.length;
    totalAdminsEl.textContent = allUsers.filter(u => u.rank === 'Admin' || u.rank === 'CEO').length;
    totalBannedEl.textContent = allUsers.filter(u => u.banned).length;
    
    allUsers.forEach(user => {
      const card = createUserCard(user);
      usersGrid.appendChild(card);
    });
    
    loadingContainer.classList.add('hidden');
    
  } catch (e) {
    showError(`Failed to load users: ${e.message}`);
    loadingContainer.classList.add('hidden');
  }
}

function createUserCard(user) {
  const card = document.createElement('div');
  card.className = 'user-card';
  
  const isCEO = user.rank === 'CEO';
  const isAdmin = user.rank === 'Admin';
  const isBanned = user.banned;
  
  let badges = '';
  if (isBanned) badges += '<span class="rank-badge banned">Banned</span>';
  if (isCEO) badges += '<span class="rank-badge ceo">CEO</span>';
  else if (isAdmin) badges += '<span class="rank-badge admin">Admin</span>';
  
  const joinDate = user.createdAt?.toDate ? user.createdAt.toDate() : new Date(user.createdAt);
  const joinedStr = joinDate.toLocaleDateString('en-US', {month: 'short', year: 'numeric'});
  
  card.innerHTML = `
    <div class="user-header">
      <img class="user-avatar" src="${user.avatar || 'https://via.placeholder.com/60'}" alt="${user.displayName}">
      <div class="user-info">
        <div class="user-display">
          ${user.displayName}
          ${badges}
        </div>
        <div class="user-username">@${user.username}</div>
      </div>
    </div>
    <div class="user-meta">
      <span>ðŸ‘¤ User #${user.uid || 'N/A'}</span>
      <span>ðŸ“… ${joinedStr}</span>
    </div>
    <div class="actions" id="actions-${user.userId}"></div>
  `;
  
  const actionsDiv = card.querySelector(`#actions-${user.userId}`);
  
  if (isCEO) {
    actionsDiv.innerHTML = '<span style="color:rgba(255,255,255,0.5);font-size:0.9em;font-style:italic;">Protected account</span>';
  } else {
    if (isBanned) {
      const btn = document.createElement('button');
      btn.className = 'btn success';
      btn.textContent = 'Unban';
      btn.onclick = () => unbanUser(user);
      actionsDiv.appendChild(btn);
    } else {
      const banBtn = document.createElement('button');
      banBtn.className = 'btn danger';
      banBtn.textContent = 'Ban';
      banBtn.onclick = () => banUser(user);
      actionsDiv.appendChild(banBtn);
    }
    
    const muteBtn = document.createElement('button');
    muteBtn.className = 'btn';
    muteBtn.textContent = user.muted ? 'Unmute' : 'Mute';
    muteBtn.onclick = () => muteUser(user);
    actionsDiv.appendChild(muteBtn);
    
    const renameBtn = document.createElement('button');
    renameBtn.className = 'btn';
    renameBtn.textContent = 'Rename';
    renameBtn.onclick = () => renameUser(user);
    actionsDiv.appendChild(renameBtn);
    
    const rankBtn = document.createElement('button');
    rankBtn.className = 'btn';
    rankBtn.textContent = 'Change Rank';
    rankBtn.onclick = () => changeRank(user);
    actionsDiv.appendChild(rankBtn);
  }
  
  return card;
}

async function banUser(user) {
  const body = `
    <div class="form-group">
      <label class="form-label">Ban Type</label>
      <select id="banType" class="form-select">
        <option value="perm">Permanent</option>
        <option value="temp">Temporary</option>
      </select>
    </div>
    <div class="form-group hidden" id="tempFields">
      <label class="form-label">Duration</label>
      <div style="display:flex;gap:10px;">
        <input type="number" id="banDuration" class="form-input" min="1" value="1" style="flex:1;">
        <select id="banUnit" class="form-select" style="flex:1;">
          <option value="m">Minutes</option>
          <option value="h">Hours</option>
          <option value="d">Days</option>
          <option value="w">Weeks</option>
          <option value="y">Years</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Reason (visible to user)</label>
      <textarea id="banReason" class="form-textarea" placeholder="Violating terms of service"></textarea>
    </div>
  `;
  
  showModal(`Ban @${user.username}`, body, async () => {
    const banType = document.getElementById('banType').value;
    const reason = document.getElementById('banReason').value.trim() || 'No reason given';
    
    let until = null;
    if (banType === 'temp') {
      const duration = parseInt(document.getElementById('banDuration').value);
      const unit = document.getElementById('banUnit').value;
      const multipliers = {m: 60000, h: 3600000, d: 86400000, w: 604800000, y: 31536000000};
      const ms = duration * multipliers[unit];
      until = Timestamp.fromMillis(Date.now() + ms);
    }
    
    await setDoc(doc(db, 'bans', user.userId), {
      until,
      reason,
      by: auth.currentUser.uid,
      at: serverTimestamp()
    });
  });
  
  setTimeout(() => {
    const banType = document.getElementById('banType');
    const tempFields = document.getElementById('tempFields');
    banType.onchange = () => {
      tempFields.classList.toggle('hidden', banType.value === 'perm');
    };
  }, 100);
}

async function unbanUser(user) {
  const banInfo = user.banData ? `<p style="color:rgba(255,255,255,0.7);margin-bottom:15px;">Reason: ${user.banData.reason}</p>` : '';
  showModal(
    `Unban @${user.username}`,
    `${banInfo}<p style="color:rgba(255,255,255,0.9);">Are you sure you want to unban this user?</p>`,
    async () => {
      await deleteDoc(doc(db, 'bans', user.userId));
    }
  );
}

async function muteUser(user) {
  const action = user.muted ? 'unmute' : 'mute';
  showModal(
    `${action.charAt(0).toUpperCase() + action.slice(1)} @${user.username}`,
    `<p style="color:rgba(255,255,255,0.9);">Are you sure you want to ${action} this user?</p>`,
    async () => {
      await updateDoc(doc(db, 'users', user.userId), {muted: !user.muted});
    }
  );
}

async function renameUser(user) {
  const body = `
    <div class="form-group">
      <label class="form-label">New Display Name</label>
      <input type="text" id="newName" class="form-input" value="${user.displayName}" maxlength="30">
    </div>
  `;
  
  showModal(`Rename @${user.username}`, body, async () => {
    const newName = document.getElementById('newName').value.trim();
    if (!newName) throw new Error('Name cannot be empty');
    await updateDoc(doc(db, 'users', user.userId), {displayName: newName});
  });
}

async function changeRank(user) {
  const body = `
    <div class="form-group">
      <label class="form-label">Select Rank</label>
      <select id="newRank" class="form-select">
        <option value="Member">Member</option>
        <option value="Admin">Admin</option>
      </select>
    </div>
  `;
  
  showModal(`Change Rank for @${user.username}`, body, async () => {
    const newRank = document.getElementById('newRank').value;
    await updateDoc(doc(db, 'users', user.userId), {rank: newRank});
  });
  
  setTimeout(() => {
    document.getElementById('newRank').value = user.rank || 'Member';
  }, 100);
}
</script>

</body>
</html>
